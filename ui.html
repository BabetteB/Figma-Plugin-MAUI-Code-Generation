<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Example</title>
    <style>
        /* .draggable_modal--positionedContainer--8AmbN{
            width: 100%;
            height: 100%;
        } */
        .frame {
            width: 300px;
            height: 300px;
            border: 1px solid #ccc;
            padding: 20px;
        }
        h1 {
            text-align: left;
        }
        .popup-button {
            text-align: right;
            margin-right: 15px;
        }
        .node {
            display: flex;
            align-items: center
        }
        .nodeDiv {
            width: -webkit-fill-available;
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            margin-top: 4px;
            margin-right: 10px;
            padding: 4px;
            
        }
        .select{
            border-radius: 0.3rem;
        }
        .children {
            display: none; /* Initially hide children */
        }
        .unfolded {
            display: block; /* Show children when unfolded */
        }
        .button-bar{       
            display: flex;
            justify-content: space-between;
            align-items: flex-end; 
            padding: 20px;
        }
        #save-button{
            color: white;
            background-color: rgb(83, 88, 209);
            border-radius: 0.5rem;
            border: 2px solid rgb(83, 88, 209);
        }
        #export-button{
            color: white;
            background-color: rgb(75, 75, 75);
            border-radius: 0.5rem;
            border: 2px solid rgb(75, 75, 75);
        }
        hr{
            width: 95%;
        }
    </style>
</head>
<body>
    <div>
        <h3>Figma Design 2 .NET MAUI Code Generator</h3>

        <div class="popup-button">
            <a href="#" id="popup-link">How 2 use?</a>
        </div>

        <ul id="node-list">
            <!-- JavaScript will populate this list -->
        </ul>
        <hr>

        <div class="button-bar">
          <button class="button" id="save-button">Save</button>
          <button class="button" id="export-button">Export Design</button>
        </div>
    </div>

<script>

  onmessage = (event) => {
    const data = event.data.pluginMessage;
    console.log('data: ', data);

    if (data.type === 'init') {
        const selectedValues = [];
        function createNodeElement(node) {
            const listItem = document.createElement('li');
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'nodeDiv';
            const textDiv = document.createElement('div');
            const select = document.createElement('select');

            textDiv.textContent = node.parent.name;
            nodeDiv.appendChild(textDiv);

            select.className = 'select';
            select.innerHTML = `
                <div class="node-name">${node.parent.name}</div>
                <div>
                    <select>
                        <option value="" disabled selected>Select value</option>
                        <option value="none">None</option>
                        <option value="image">Image</option>
                        <option value="label">Label</option>
                        <option value="button">Button</option>
                        <option value="image-button">ImageButton</option>
                        <option value="swipe-view">SwipeView</option>
                        <option value="check-box">CheckBox</option>
                        <option value="slider">Slider</option>
                        <option value="switch">Switch</option>
                        <option value="editor">Editor</option>
                        <option value="entry">Entry</option>
                        <option value="list-view">ListView</option>
                        <option value="table-view">TableView</option>
                        <option value="menu-item">MenuItem</option>
                        <option value="toolbar-item">ToolbarItem</option>
                        <option value="display-pop-ups">Display Pop-ups</option>
                    </select>
                </div>
                `;

                select.addEventListener('change', (event) => {
                    
                    const selectedValue = event.target.value;
                    selectedValues.push({node, selectedValue});
                });

                nodeDiv.appendChild(select);
                listItem.appendChild(nodeDiv);

                if (node.children.length > 0) {
                    const childrenList = document.createElement('ul');
                    childrenList.className = 'children';

                    node.children.forEach((child) => {
                        const childNodeElement = createNodeElement(child);
                        childrenList.appendChild(childNodeElement);
                    });

                    listItem.appendChild(childrenList);

                    // Add click event to toggle children visibility
                    textDiv.style.cursor = 'pointer';
                    textDiv.addEventListener('click', () => {
                        childrenList.classList.toggle('unfolded');
                    });
                }

            return listItem;
        }

        const nodeList = document.getElementById("node-list");

        data.nodes.forEach((node) => {
            const nodeElement = createNodeElement(node);
            nodeList.appendChild(nodeElement);
        });  

        const exportButton = document.getElementById("export-button");
        exportButton.addEventListener('click', () => {
            parent.postMessage({ pluginMessage: selectedValues }, '*')
        });
    } else if (data.type === "url") {
        const fileName = 'textfile.txt';

        download(fileName, 'Hello World!');
    }

    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }
} 
</script>
</body>
</html>
